{% extends 'base.html' %}

{% block title %}
   Upload Data
{% endblock %}

{% block content %}
    <section>
        <h2>Upload Data</h2>
        <div class="container mt-5">

            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="custom-file w-50">
                    <input type="file" class="custom-file-input" id="customFile">
                    <label class="custom-file-label primary" for="customFile">Choose file</label>
                </div>
                <br><br>
                <button type="submit" class="btn btn-primary">Start Upload</button>
            </form>

            <br>
            <h3>Upload Progress</h3>
            <div class="progress mt-3" style="height: 30px;">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
    
        <script>
            $(document).ready(function () {
                $('#uploadForm').on('submit', function (e) {
                    e.preventDefault();
                    var formData = new FormData(this);
                    $.ajax({
                        url: '',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            var file_path = response.file_path;
                            checkProgress(file_path);
                        }
                    });
                });
    
                function checkProgress(file_path) {
                    $.ajax({
                        url: '/progress-import/',
                        type: 'POST',
                        data: { 'file_path': file_path },
                        success: function (response) {
                            var current = response.current;
                            var total = response.total;
                            var percent = (current / total) * 100;
                            $('#progressBar').css('width', percent + '%').attr('aria-valuenow', percent).text(Math.round(percent) + '%');
                            if (current < total) {
                                setTimeout(function () {
                                    checkProgress(file_path);
                                }, 1000);
                            }
                        }
                    });
                }
            });
        </script>
    </section>
{% endblock %}